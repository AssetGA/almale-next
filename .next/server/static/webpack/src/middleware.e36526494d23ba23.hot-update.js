"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
self["webpackHotUpdate_N_E"]("src/middleware",{

/***/ "(middleware)/./src/app/lib/session.js":
/*!********************************!*\
  !*** ./src/app/lib/session.js ***!
  \********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   createSession: () => (/* binding */ createSession),\n/* harmony export */   decrypt: () => (/* binding */ decrypt),\n/* harmony export */   deleteSession: () => (/* binding */ deleteSession),\n/* harmony export */   encrypt: () => (/* binding */ encrypt),\n/* harmony export */   fetchCreateSession: () => (/* binding */ fetchCreateSession),\n/* harmony export */   getSessionCookie: () => (/* binding */ getSessionCookie),\n/* harmony export */   updateSession: () => (/* binding */ updateSession)\n/* harmony export */ });\n/* harmony import */ var server_only__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! server-only */ \"(middleware)/./node_modules/next/dist/compiled/server-only/empty.js\");\n/* harmony import */ var server_only__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(server_only__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_headers__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/headers */ \"(middleware)/./node_modules/next/dist/esm/api/headers.js\");\n/* harmony import */ var jose__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! jose */ \"(middleware)/./node_modules/jose/dist/browser/jwt/sign.js\");\n/* harmony import */ var jose__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! jose */ \"(middleware)/./node_modules/jose/dist/browser/jwt/verify.js\");\n\n\n\nconst secretKey = process.env.SESSION_SECRET;\nconst encodedKey = new TextEncoder().encode(secretKey);\nasync function encrypt(payload) {\n    return new jose__WEBPACK_IMPORTED_MODULE_2__.SignJWT(payload).setProtectedHeader({\n        alg: \"HS256\"\n    }).setIssuedAt().setExpirationTime(\"1d\").sign(encodedKey);\n}\nasync function decrypt(session) {\n    try {\n        const { payload } = await (0,jose__WEBPACK_IMPORTED_MODULE_3__.jwtVerify)(session, encodedKey, {\n            algorithms: [\n                \"HS256\"\n            ]\n        });\n        return payload;\n    } catch (error) {\n        console.log(\"Failed to verify session\");\n    }\n}\nasync function fetchCreateSession(id) {\n    try {\n        const url = new URL(`${\"http://localhost:3000\"}/lib/api/session`);\n        url.searchParams.append(\"id\", id); // Добавляем параметр lang\n        const res = await fetch(url.toString(), {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\"\n            },\n            body: JSON.stringify({\n                id\n            })\n        });\n        if (!res.ok) throw new Error(\"Ошибка при загрузке товаров\");\n        const session = await res.json();\n        return session;\n    } catch (error) {\n        console.error(\"Error fetching products:\", error);\n        return []; // Возвращаем пустой массив, если произошла ошибка\n    }\n}\nasync function createSession(id) {\n    // await connectToDatabase();\n    // const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);\n    // // 1. Create a session in the database\n    // const data = await Session.create({\n    //   userId: id,\n    //   expiresAt,\n    //   role: \"user\",\n    // });\n    const data = await fetchCreateSession(id);\n    const sessionId = data._id;\n    const expiresAt = new Date(data.expiresAt);\n    // 2. Encrypt the session ID\n    const session = await encrypt({\n        sessionId,\n        userId: data.userId,\n        expiresAt: expiresAt,\n        role: data.role\n    });\n    // 3. Store the session in cookies for optimistic auth checks\n    const cookieStore = await (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.cookies)();\n    cookieStore.set(\"session\", session, {\n        httpOnly: true,\n        secure: true,\n        expires: expiresAt,\n        sameSite: \"lax\",\n        path: \"/\"\n    });\n    return data;\n}\nasync function updateSession() {\n    const session = (await (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.cookies)()).get(\"session\")?.value;\n    const payload = await decrypt(session);\n    if (!session || !payload) {\n        return null;\n    }\n    const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)(await (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.cookies)()).set(\"session\", session, {\n        httpOnly: true,\n        secure: true,\n        expires: expires,\n        sameSite: \"lax\",\n        path: \"/\"\n    });\n}\nfunction getSessionCookie() {\n    return (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.cookies)().get(\"session\");\n}\nasync function deleteSession() {\n    const cookieStore = await (0,next_headers__WEBPACK_IMPORTED_MODULE_1__.cookies)();\n    cookieStore.delete(\"session\");\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QU07SUFDUjtBQUNGO0FBRU8sU0FBU0s7SUFDZCxPQUFPNUQscURBQU9BLEdBQUd5RCxHQUFHLENBQUM7QUFDdkI7QUFFTyxlQUFlSTtJQUNwQixNQUFNWixjQUFjLE1BQU1qRCxxREFBT0E7SUFFakNpRCxZQUFZYSxNQUFNLENBQUM7QUFDckIiLCJzb3VyY2VzIjpbIi9ob21lL2Fzc2V0L3Byb2plY3RzL2FsbWFsZS9hbG1hbGUtbmV4dC9zcmMvYXBwL2xpYi9zZXNzaW9uLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBcInNlcnZlci1vbmx5XCI7XG5pbXBvcnQgeyBjb29raWVzIH0gZnJvbSBcIm5leHQvaGVhZGVyc1wiO1xuaW1wb3J0IHsgU2lnbkpXVCwgand0VmVyaWZ5IH0gZnJvbSBcImpvc2VcIjtcblxuY29uc3Qgc2VjcmV0S2V5ID0gcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVQ7XG5jb25zdCBlbmNvZGVkS2V5ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHNlY3JldEtleSk7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBlbmNyeXB0KHBheWxvYWQpIHtcbiAgcmV0dXJuIG5ldyBTaWduSldUKHBheWxvYWQpXG4gICAgLnNldFByb3RlY3RlZEhlYWRlcih7IGFsZzogXCJIUzI1NlwiIH0pXG4gICAgLnNldElzc3VlZEF0KClcbiAgICAuc2V0RXhwaXJhdGlvblRpbWUoXCIxZFwiKVxuICAgIC5zaWduKGVuY29kZWRLZXkpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVjcnlwdChzZXNzaW9uKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBwYXlsb2FkIH0gPSBhd2FpdCBqd3RWZXJpZnkoc2Vzc2lvbiwgZW5jb2RlZEtleSwge1xuICAgICAgYWxnb3JpdGhtczogW1wiSFMyNTZcIl0sXG4gICAgfSk7XG4gICAgcmV0dXJuIHBheWxvYWQ7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5sb2coXCJGYWlsZWQgdG8gdmVyaWZ5IHNlc3Npb25cIik7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZldGNoQ3JlYXRlU2Vzc2lvbihpZCkge1xuICB0cnkge1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoYCR7cHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfU0lURV9VUkx9L2xpYi9hcGkvc2Vzc2lvbmApO1xuICAgIHVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKFwiaWRcIiwgaWQpOyAvLyDQlNC+0LHQsNCy0LvRj9C10Lwg0L/QsNGA0LDQvNC10YLRgCBsYW5nXG4gICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2godXJsLnRvU3RyaW5nKCksIHtcbiAgICAgIG1ldGhvZDogXCJQT1NUXCIsIC8vINCj0LrQsNC30YvQstCw0LXQvCDQvNC10YLQvtC0IFBPU1RcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsIC8vINCj0YHRgtCw0L3QsNCy0LvQuNCy0LDQtdC8INC30LDQs9C+0LvQvtCy0L7QulxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgaWQgfSksIC8vINCf0LXRgNC10LTQsNGR0Lwg0LTQsNC90L3Ri9C1INCyINGC0LXQu9C1INC30LDQv9GA0L7RgdCwXG4gICAgfSk7XG5cbiAgICBpZiAoIXJlcy5vaykgdGhyb3cgbmV3IEVycm9yKFwi0J7RiNC40LHQutCwINC/0YDQuCDQt9Cw0LPRgNGD0LfQutC1INGC0L7QstCw0YDQvtCyXCIpO1xuICAgIGNvbnN0IHNlc3Npb24gPSBhd2FpdCByZXMuanNvbigpO1xuICAgIHJldHVybiBzZXNzaW9uO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBmZXRjaGluZyBwcm9kdWN0czpcIiwgZXJyb3IpO1xuICAgIHJldHVybiBbXTsgLy8g0JLQvtC30LLRgNCw0YnQsNC10Lwg0L/Rg9GB0YLQvtC5INC80LDRgdGB0LjQsiwg0LXRgdC70Lgg0L/RgNC+0LjQt9C+0YjQu9CwINC+0YjQuNCx0LrQsFxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVTZXNzaW9uKGlkKSB7XG4gIC8vIGF3YWl0IGNvbm5lY3RUb0RhdGFiYXNlKCk7XG4gIC8vIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKERhdGUubm93KCkgKyA3ICogMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgLy8gLy8gMS4gQ3JlYXRlIGEgc2Vzc2lvbiBpbiB0aGUgZGF0YWJhc2VcblxuICAvLyBjb25zdCBkYXRhID0gYXdhaXQgU2Vzc2lvbi5jcmVhdGUoe1xuICAvLyAgIHVzZXJJZDogaWQsXG4gIC8vICAgZXhwaXJlc0F0LFxuICAvLyAgIHJvbGU6IFwidXNlclwiLFxuICAvLyB9KTtcbiAgY29uc3QgZGF0YSA9IGF3YWl0IGZldGNoQ3JlYXRlU2Vzc2lvbihpZCk7XG5cbiAgY29uc3Qgc2Vzc2lvbklkID0gZGF0YS5faWQ7XG4gIGNvbnN0IGV4cGlyZXNBdCA9IG5ldyBEYXRlKGRhdGEuZXhwaXJlc0F0KTtcblxuICAvLyAyLiBFbmNyeXB0IHRoZSBzZXNzaW9uIElEXG5cbiAgY29uc3Qgc2Vzc2lvbiA9IGF3YWl0IGVuY3J5cHQoe1xuICAgIHNlc3Npb25JZCxcbiAgICB1c2VySWQ6IGRhdGEudXNlcklkLFxuICAgIGV4cGlyZXNBdDogZXhwaXJlc0F0LFxuICAgIHJvbGU6IGRhdGEucm9sZSxcbiAgfSk7XG5cbiAgLy8gMy4gU3RvcmUgdGhlIHNlc3Npb24gaW4gY29va2llcyBmb3Igb3B0aW1pc3RpYyBhdXRoIGNoZWNrc1xuICBjb25zdCBjb29raWVTdG9yZSA9IGF3YWl0IGNvb2tpZXMoKTtcbiAgY29va2llU3RvcmUuc2V0KFwic2Vzc2lvblwiLCBzZXNzaW9uLCB7XG4gICAgaHR0cE9ubHk6IHRydWUsXG4gICAgc2VjdXJlOiB0cnVlLFxuICAgIGV4cGlyZXM6IGV4cGlyZXNBdCxcbiAgICBzYW1lU2l0ZTogXCJsYXhcIixcbiAgICBwYXRoOiBcIi9cIixcbiAgfSk7XG4gIHJldHVybiBkYXRhO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlU2Vzc2lvbigpIHtcbiAgY29uc3Qgc2Vzc2lvbiA9IChhd2FpdCBjb29raWVzKCkpLmdldChcInNlc3Npb25cIik/LnZhbHVlO1xuICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZGVjcnlwdChzZXNzaW9uKTtcblxuICBpZiAoIXNlc3Npb24gfHwgIXBheWxvYWQpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgNyAqIDI0ICogNjAgKiA2MCAqIDEwMDApKFxuICAgIGF3YWl0IGNvb2tpZXMoKVxuICApLnNldChcInNlc3Npb25cIiwgc2Vzc2lvbiwge1xuICAgIGh0dHBPbmx5OiB0cnVlLFxuICAgIHNlY3VyZTogdHJ1ZSxcbiAgICBleHBpcmVzOiBleHBpcmVzLFxuICAgIHNhbWVTaXRlOiBcImxheFwiLFxuICAgIHBhdGg6IFwiL1wiLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNlc3Npb25Db29raWUoKSB7XG4gIHJldHVybiBjb29raWVzKCkuZ2V0KFwic2Vzc2lvblwiKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRlbGV0ZVNlc3Npb24oKSB7XG4gIGNvbnN0IGNvb2tpZVN0b3JlID0gYXdhaXQgY29va2llcygpO1xuXG4gIGNvb2tpZVN0b3JlLmRlbGV0ZShcInNlc3Npb25cIik7XG59XG4iXSwibmFtZXMiOlsiY29va2llcyIsIlNpZ25KV1QiLCJqd3RWZXJpZnkiLCJzZWNyZXRLZXkiLCJwcm9jZXNzIiwiZW52IiwiU0VTU0lPTl9TRUNSRVQiLCJlbmNvZGVkS2V5IiwiVGV4dEVuY29kZXIiLCJlbmNvZGUiLCJlbmNyeXB0IiwicGF5bG9hZCIsInNldFByb3RlY3RlZEhlYWRlciIsImFsZyIsInNldElzc3VlZEF0Iiwic2V0RXhwaXJhdGlvblRpbWUiLCJzaWduIiwiZGVjcnlwdCIsInNlc3Npb24iLCJhbGdvcml0aG1zIiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwiZmV0Y2hDcmVhdGVTZXNzaW9uIiwiaWQiLCJ1cmwiLCJVUkwiLCJORVhUX1BVQkxJQ19TSVRFX1VSTCIsInNlYXJjaFBhcmFtcyIsImFwcGVuZCIsInJlcyIsImZldGNoIiwidG9TdHJpbmciLCJtZXRob2QiLCJoZWFkZXJzIiwiYm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJvayIsIkVycm9yIiwianNvbiIsImNyZWF0ZVNlc3Npb24iLCJkYXRhIiwic2Vzc2lvbklkIiwiX2lkIiwiZXhwaXJlc0F0IiwiRGF0ZSIsInVzZXJJZCIsInJvbGUiLCJjb29raWVTdG9yZSIsInNldCIsImh0dHBPbmx5Iiwic2VjdXJlIiwiZXhwaXJlcyIsInNhbWVTaXRlIiwicGF0aCIsInVwZGF0ZVNlc3Npb24iLCJnZXQiLCJ2YWx1ZSIsIm5vdyIsImdldFNlc3Npb25Db29raWUiLCJkZWxldGVTZXNzaW9uIiwiZGVsZXRlIl0sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(middleware)/./src/app/lib/session.js\n");

/***/ })

});